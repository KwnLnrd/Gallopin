<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gallopin</title>
    <link rel="icon" type="image/png" href="https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://gallopin.com/&size=16">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- DESIGN SYSTEM & STYLES GLOBAUX POUR GALLOPIN --- */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@400;500;600;700&display=swap');
        
        :root {
            --sidebar-width-expanded: 260px;
            --sidebar-width-collapsed: 88px;
            --brand-color: #21304F;
            --brand-color-light: rgba(33, 48, 79, 0.1);
            --brand-color-dark: #152035;
            --background-color: #F8F9FA;
            --surface-color: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --border-color: #DEE2E6;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Montserrat', sans-serif;
            --danger-color: #D32F2F;
            --danger-color-light: rgba(211, 47, 47, 0.1);
            --edit-color: #1976D2;
            --success-color: #28a745;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.05), 0 1px 2px rgba(0,0,0,.03);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-sans); background-color: var(--background-color); color: var(--text-primary); margin: 0; }
        .hidden { display: none !important; }

        /* --- LAYOUT & NAVIGATION --- */
        .main-layout { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-width-expanded); background-color: var(--surface-color); border-right: 1px solid var(--border-color); padding: 20px; box-sizing: border-box; height: 100%; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; transition: width 0.3s ease; overflow-x: hidden; z-index: 100; }
        .sidebar .logo-link { display: flex; align-items: center; justify-content: center; height: 60px; margin-bottom: 30px; }
        .sidebar .logo-link img { height: 50px; width: auto; max-width: 180px; }
        .main-content-area { margin-left: var(--sidebar-width-expanded); width: calc(100% - var(--sidebar-width-expanded)); height: 100%; overflow-y: auto; padding: 30px; box-sizing: border-box; transition: margin-left 0.3s ease, width 0.3s ease; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .content-header h1 { font-family: var(--font-serif); font-size: 2.8rem; margin: 0; }
        .nav-tabs { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }
        .nav-tab { display: flex; align-items: center; gap: 12px; padding: 12px 15px; cursor: pointer; border: none; background: none; font-size: 1rem; font-weight: 500; color: var(--text-secondary); border-radius: 8px; transition: all 0.2s; text-align: left; white-space: nowrap; }
        .nav-tab:hover { background-color: var(--background-color); color: var(--text-primary); }
        .nav-tab.active { background-color: var(--brand-color-light); color: var(--brand-color); font-weight: 600; }
        .nav-tab svg { width: 20px; height: 20px; flex-shrink: 0; }
        
        /* --- MODALS --- */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(5px); padding: 15px;}
        .modal-content{background:var(--surface-color);padding:40px;border-radius:16px;box-shadow:var(--shadow-lg);text-align:center;width:100%;max-width:400px; box-sizing: border-box;}
        #password-form input{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:1rem;box-sizing:border-box;margin-bottom:15px}
        #password-form button{background-color:var(--brand-color);color:#fff;border:none;padding:14px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;width:100%;}
        .error-message{color:var(--danger-color);font-size:.9rem;margin-top:10px;min-height:1.2em}
        .modal-buttons .confirm-btn { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }

        /* --- COMPOSANTS UI --- */
        .card { background-color: var(--surface-color); padding: 25px; border-radius: 12px; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .card-title { font-family: var(--font-serif); font-size: 1.6rem; color: var(--text-primary); }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .filters select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .loader-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: 12px; }
        .loader { width: 40px; height: 40px; border: 4px solid var(--border-color); border-left-color: var(--brand-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- STYLES SPÉCIFIQUES AUX PAGES --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card .stat-value { font-family: var(--font-serif); font-size: 2.5rem; }
        #unread-feedback-stat .stat-value { color: var(--brand-color); }
        #unread-feedback-stat .notification-dot { width: 12px; height: 12px; background-color: var(--brand-color); border-radius: 50%; display: inline-block; margin-left: 8px; }
        .overview-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .page-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .feedback-list { display: grid; gap: 20px; }
        .feedback-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-left: 5px solid var(--brand-color); border-radius: 8px; padding: 20px; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; }
        .item-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .add-form { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .add-form input, .add-form select { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; }
        .add-form button { background-color: var(--brand-color); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; align-self: flex-end; }
        .danger-zone { border: 2px solid var(--danger-color); background-color: var(--danger-color-light); }
        .danger-zone button { background-color: var(--danger-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; }

        /* --- STYLES POUR SIF --- */
        .sif-grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: auto auto; gap: 30px; }
        #sif-synthesis-card { grid-column: 1 / 2; grid-row: 1 / 2; }
        #sif-sentiment-card { grid-column: 2 / 3; grid-row: 1 / 2; }
        #sif-suggestions-card { grid-column: 1 / 2; grid-row: 2 / 3; }
        #sif-categories-card { grid-column: 2 / 3; grid-row: 2 / 3; }
        .sif-synthesis-content { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .sif-list h4 { font-size: 1rem; margin: 0 0 15px 0; }
        .sif-list ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .sif-list li { background-color: var(--background-color); padding: 12px 15px; border-radius: 8px; }
        #sif-suggestions-list .suggestion-item { background-color: var(--background-color); padding: 15px; border-radius: 8px; margin-bottom: 12px; }
        #sif-suggestions-list .suggestion-category { font-weight: 700; color: var(--brand-color); }

        /* --- RESPONSIVE --- */
        .mobile-menu-toggle { display: none; }
        @media (max-width: 1200px) { .sif-grid { grid-template-columns: 1fr; } }
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); z-index: 2000; }
            .sidebar.open { transform: translateX(0); }
            .main-content-area { margin-left: 0; width: 100%; }
            .mobile-menu-toggle { display: block; position: fixed; top: 15px; left: 15px; z-index: 2001; background: var(--surface-color); border: 1px solid var(--border-color); padding: 10px; cursor: pointer; }
        }
        @media (max-width: 768px) { .page-grid, .settings-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Accès Sécurisé</h2>
            <p>Veuillez entrer le mot de passe pour accéder au tableau de bord Gallopin.</p>
            <form id="password-form">
                <input type="password" id="password-input" placeholder="Mot de passe" required>
                <button type="submit" id="submit-password-btn">Valider</button>
            </form>
            <p id="password-error" class="error-message"></p>
        </div>
    </div>

    <div class="main-layout hidden" id="main-layout">
        <aside class="sidebar" id="sidebar">
            <a href="#" class="logo-link"><img src="https://i.ibb.co/W4nVd6jD/Gallopin-logo.png" alt="Logo Gallopin"></a>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="overview">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    <span class="nav-text">Vue d'ensemble</span>
                </button>
                <button class="nav-tab" data-tab="sif">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.29 15.29L7.41 14l-1.42 1.41L10 18.12l4.29-4.29-1.41-1.41L10.71 15.3c.39-.39.75-.82 1.07-1.3H16v-1.5h-3.88c-.22-.71-.52-1.38-.89-1.98l1.4-1.4c.39-.39.39-1.02 0-1.41a.996.996 0 00-1.41 0l-1.48 1.48C8.96 8.16 8.5 7.79 8.07 7.51L8.5 6.06a.996.996 0 000-1.41.996.996 0 00-1.41 0L6.06 5.71c-.75.25-1.44.64-2.06 1.15l-1.41-1.41-1.41 1.41 1.41 1.41C2.16 9.29 2 10.11 2 11c0 1.1.9 2 2 2h1v1H4c-1.1 0-2-.9-2-2 0-.52.1-1.02.28-1.47l.88.88C5.02 10.78 5 11.38 5 12c0 .83.34 1.57.88 2.12L7 15.21l.71.71c.38.38.89.65 1.45.79v1.54h1.5v-1.54c.56-.14 1.06-.41 1.45-.79l.71-.71.09-.09c-1.13-.67-2.02-1.66-2.56-2.82H8v-1.5h2.03c.1-.34.23-.67.38-.98L9 10.41l1.41-1.41 1.41 1.41c.18-.15.37-.29.57-.42L10.81 8.41 12.22 7l1.59 1.59c.19-.09.38-.17.58-.24l.42-1.59 1.5-.4-1.5.4-.42 1.59c-.2.07-.39.15-.58.24L12.22 10l-1.41 1.41 1.41 1.41c-.15.2-.29.4-.42.62H15V15h-1.5v-1.5h-1.07c-.54 1.16-1.43 2.15-2.56 2.82l-.17-.16z"/></svg>
                    <span class="nav-text">Synthèse SIF</span>
                </button>
                <button class="nav-tab" data-tab="stats-serveurs">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    <span class="nav-text">Stats Serveurs</span>
                </button>
                <button class="nav-tab" data-tab="performance-menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
                    <span class="nav-text">Performance Menu</span>
                </button>
                <button class="nav-tab" data-tab="feedback-interne">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 5.72l-4.6-3.86-1.29 1.53 4.6 3.86L22 5.72zM7.88 3.39L6.6 1.86 2 5.71l1.29 1.53 4.59-3.85zM12.5 8H11v6l4.75 2.85.75-1.23-4-2.37V8zM12 4c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm0 16c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/></svg>
                    <span class="nav-text">Feedback Interne</span>
                </button>
                <button class="nav-tab" data-tab="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                    <span class="nav-text">Paramètres</span>
                </button>
            </nav>
        </aside>

        <div class="main-content-area" id="main-content">
            <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            
            <header class="content-header">
                <h1 id="page-title">Vue d'ensemble</h1>
                <div class="filters" id="global-period-filter-container">
                    <label for="global-period-select">Période :</label>
                    <select id="global-period-select">
                        <option value="all">Tout</option>
                        <option value="30days">30 derniers jours</option>
                        <option value="7days" selected>7 derniers jours</option>
                    </select>
                </div>
            </header>

            <main>
                <div id="overview-tab" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card"><h3>Avis (Période)</h3><p id="reviews-period-stat" class="stat-value">...</p></div>
                        <div class="stat-card"><h3>Moyenne / jour</h3><p id="avg-reviews-stat" class="stat-value">...</p></div>
                        <div class="stat-card" id="unread-feedback-stat"><h3>Feedbacks non lus</h3><p id="unread-feedback-count" class="stat-value">...</p></div>
                    </div>
                    <div class="overview-grid">
                        <div class="card"><h2 class="card-title">Tendance des Avis</h2><div class="chart-container"><canvas id="reviews-trend-chart"></canvas></div></div>
                    </div>
                </div>

                <div id="sif-tab" class="tab-content hidden">
                    <div class="sif-grid">
                        <div class="card" id="sif-synthesis-card" style="position: relative;">
                            <h2 class="card-title">Synthèse de la Période</h2>
                            <div class="sif-synthesis-content">
                                <div class="sif-list" id="sif-strengths"><h4>POINTS FORTS</h4><ul></ul></div>
                                <div class="sif-list" id="sif-weaknesses"><h4>POINTS FAIBLES</h4><ul></ul></div>
                            </div>
                        </div>
                        <div class="card" id="sif-sentiment-card" style="position: relative;"><h2 class="card-title">Tendance du Sentiment</h2><div class="chart-container"><canvas id="sif-sentiment-chart"></canvas></div></div>
                        <div class="card" id="sif-suggestions-card" style="position: relative;"><h2 class="card-title">💡 Suggestions de l'IA</h2><div id="sif-suggestions-list"></div></div>
                        <div class="card" id="sif-categories-card" style="position: relative;"><h2 class="card-title">Catégorisation des Feedbacks</h2><div class="chart-container"><canvas id="sif-categories-chart"></canvas></div></div>
                    </div>
                </div>

                <div id="stats-serveurs-tab" class="tab-content hidden"><div class="page-grid"><div class="card"><h2 class="card-title">Classement des Serveurs</h2><table id="ranking-table"><thead><tr><th>#</th><th>Serveur</th><th>Avis</th></tr></thead><tbody></tbody></table></div><div class="card"><h2 class="card-title">Répartition des avis</h2><div class="chart-container" style="height: 400px;"><canvas id="server-distribution-chart"></canvas></div></div></div></div>
                <div id="performance-menu-tab" class="tab-content hidden"><div class="page-grid"><div class="card"><h2 class="card-title">Performance des Plats</h2><div id="full-data-table-container" style="max-height: 500px; overflow-y: auto;"></div></div><div class="card"><h2 class="card-title">Performance par Catégorie</h2><div class="chart-container"><canvas id="category-pie-chart"></canvas></div></div></div></div>
                <div id="feedback-interne-tab" class="tab-content hidden"><div id="feedback-list" class="feedback-list"></div></div>
                <div id="settings-tab" class="tab-content hidden">
                    <div class="settings-grid">
                        <div class="card" id="servers-section">
                            <h2 class="card-title">Gérer les Serveurs</h2>
                            <ul id="servers-list" class="item-list"></ul>
                            <form id="add-server-form" class="add-form"><input type="text" id="new-server-name" placeholder="Prénom" required><button type="submit">Ajouter</button></form>
                        </div>
                        <div class="card" id="flavors-section">
                            <h2 class="card-title">Gérer les Plats</h2>
                            <ul id="flavors-list" class="item-list"></ul>
                            <form id="add-flavor-form" class="add-form">
                                <input type="text" id="new-flavor-text" placeholder="Nom du plat" required>
                                <select id="new-flavor-category" required>
                                    <option value="" disabled selected>Catégorie</option>
                                    <option value="Entrées">Entrées</option>
                                    <option value="Plats">Plats</option>
                                    <option value="Desserts">Desserts</option>
                                </select>
                                <button type="submit">Ajouter</button>
                            </form>
                        </div>
                        <div class="card danger-zone"><h2 class="card-title">Zone de Danger</h2><p>Réinitialise toutes les statistiques.</p><button id="reset-data-btn">Réinitialiser</button></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'https://gallopin.onrender.com';
        let charts = { reviewsTrend: null, serverDistribution: null, categoryPie: null, sifSentiment: null, sifCategories: null };
        const pageTitles = { 
            overview: "Vue d'ensemble", sif: "Synthèse Intelligente (SIF)", 'stats-serveurs': "Statistiques Serveurs", 
            'performance-menu': "Performance Menu", 'feedback-interne': "Feedbacks Internes", settings: "Paramètres" 
        };

        const passwordModal = document.getElementById('password-modal');
        const mainLayout = document.getElementById('main-layout');
        const tabs = document.querySelectorAll('.nav-tab[data-tab]');
        const tabContents = document.querySelectorAll('.tab-content');
        const pageTitleEl = document.getElementById('page-title');
        const globalPeriodSelect = document.getElementById('global-period-select');
        
        if (sessionStorage.getItem('jwt_token')) {
            passwordModal.classList.add('hidden');
            mainLayout.classList.remove('hidden');
            initializeDashboard();
        }

        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: password })
                });
                if (!response.ok) throw new Error("Mot de passe incorrect.");
                const data = await response.json();
                sessionStorage.setItem('jwt_token', data.access_token);
                passwordModal.classList.add('hidden');
                mainLayout.classList.remove('hidden');
                initializeDashboard();
            } catch (error) {
                document.getElementById('password-error').textContent = error.message;
            }
        });

        async function fetchWithAuth(url, options = {}) {
            const token = sessionStorage.getItem('jwt_token');
            if (!token) { location.reload(); throw new Error("Session expirée."); }
            const headers = { ...options.headers, 'Authorization': 'Bearer ' + token };
            if (options.body && typeof options.body !== 'string') {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) { location.reload(); throw new Error("Session expirée."); }
            if (!response.ok) throw new Error(`Erreur: ${response.statusText}`);
            return response.json();
        }

        function initializeDashboard() {
            setupNavigation();
            switchTab('overview');
        }
        
        function setupNavigation() {
            tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
            globalPeriodSelect.addEventListener('change', () => loadDataForTab(document.querySelector('.nav-tab.active').dataset.tab));
            document.getElementById('mobile-menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('open'));
        }

        function switchTab(tabName) {
            tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `${tabName}-tab`));
            pageTitleEl.textContent = pageTitles[tabName] || "Dashboard";
            document.getElementById('global-period-filter-container').classList.toggle('hidden', ['settings', 'feedback-interne'].includes(tabName));
            loadDataForTab(tabName);
        }

        function loadDataForTab(tabName) {
            switch(tabName) {
                case 'overview': loadOverviewData(); break;
                case 'sif': loadSifData(); break;
                case 'stats-serveurs': loadServerStatsData(); break;
                case 'performance-menu': loadMenuPerformanceData(); break;
                case 'feedback-interne': loadInternalFeedbackData(); break;
                case 'settings': loadManagementData(); break;
            }
        }
        
        async function loadOverviewData() {
            const period = globalPeriodSelect.value;
            try {
                const [overview, unreadFeedbacks] = await Promise.all([
                    fetchWithAuth(`${API_BASE_URL}/dashboard?period=${period}`),
                    fetchWithAuth(`${API_BASE_URL}/api/internal-feedback?status=new`)
                ]);
                document.getElementById('reviews-period-stat').textContent = overview.stats.reviews_in_period;
                document.getElementById('avg-reviews-stat').textContent = overview.stats.average_reviews_per_day;
                document.getElementById('unread-feedback-count').innerHTML = `${unreadFeedbacks.length} <span class="notification-dot"></span>`;
                if (charts.reviewsTrend) charts.reviewsTrend.destroy();
                charts.reviewsTrend = new Chart(document.getElementById('reviews-trend-chart'), { type: 'line', data: { labels: overview.trend.map(d => new Date(d.date).toLocaleDateString('fr-FR')), datasets: [{ label: 'Avis', data: overview.trend.map(d => d.count), borderColor: 'var(--brand-color)', backgroundColor: 'var(--brand-color-light)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });
            } catch (error) { console.error("Erreur Overview:", error); }
        }

        function showLoader(cardId) {
            const card = document.getElementById(cardId);
            if (card && !card.querySelector('.loader-overlay')) {
                card.insertAdjacentHTML('beforeend', '<div class="loader-overlay"><div class="loader"></div></div>');
            }
        }
        function hideLoader(cardId) {
            const loader = document.querySelector(`#${cardId} .loader-overlay`);
            if (loader) loader.remove();
        }

        async function loadSifData() {
            const period = globalPeriodSelect.value;
            const cardIds = ['sif-synthesis-card', 'sif-sentiment-card', 'sif-suggestions-card', 'sif-categories-card'];
            cardIds.forEach(showLoader);
            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/api/sif-synthesis?period=${period}`);
                document.querySelector('#sif-strengths ul').innerHTML = data.strengths.map(s => `<li>${s}</li>`).join('');
                document.querySelector('#sif-weaknesses ul').innerHTML = data.weaknesses.map(w => `<li>${w}</li>`).join('');
                document.getElementById('sif-suggestions-list').innerHTML = data.suggestions.map(s => `<div class="suggestion-item"><div class="suggestion-category">${s.category}</div><p>${s.suggestion}</p></div>`).join('');
                if (charts.sifSentiment) charts.sifSentiment.destroy();
                charts.sifSentiment = new Chart(document.getElementById('sif-sentiment-chart'), { type: 'line', data: { labels: data.sentiment_trend.map(d => new Date(d.date).toLocaleDateString('fr-FR')), datasets: [{ label: 'Sentiment', data: data.sentiment_trend.map(d => d.score), borderColor: 'var(--brand-color)' }] }, options: { responsive: true, maintainAspectRatio: false } });
                if (charts.sifCategories) charts.sifCategories.destroy();
                charts.sifCategories = new Chart(document.getElementById('sif-categories-chart'), { type: 'bar', data: { labels: data.categories.map(c => c.name), datasets: [{ label: 'Score', data: data.categories.map(c => c.score), backgroundColor: 'var(--brand-color-light)', borderColor: 'var(--brand-color)', borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false } });
            } catch (error) {
                console.error("Erreur SIF:", error);
            } finally {
                cardIds.forEach(hideLoader);
            }
        }

        async function loadServerStatsData() { /* ... */ }
        async function loadMenuPerformanceData() { /* ... */ }
        async function loadInternalFeedbackData() { /* ... */ }
        async function loadManagementData() { /* ... */ }
        // Le reste du JS pour les autres onglets reste identique
    });
    </script>
</body>
</html>
